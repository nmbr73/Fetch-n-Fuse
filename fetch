#!/usr/bin/env python3

import os
import io
import re
import requests
import json
import yaml
import argparse
from dotenv import load_dotenv





# ---------------------------------------------------------------------------------------------------------------------

def patchForDCTL(code,fuse_name,buffer_name):
  """
  Do some text replacememt to make some WebGL to DCTL conversions.
  """

  code = code.replace("\t", "  ")

  code=re.sub(r'([^\w])(fragCoord)\.xy([^\w])',r'\1\2\3', code)
  code=re.sub(r'([^\w])(iResolution)\.xy([^\w])',r'\1\2\3', code)
  


#---- Dimensionen ----
  #rgba noch verbesserbar ").rgb" 
  code=re.sub(r'(\w+\.)(rgba)',r'\1xyzw', code)
  code=re.sub(r'(\w+\.)(rgb)',r'\1xyz', code)
  code=re.sub(r'(\w+\.)(rbg)',r'\1xzy', code)
  code=re.sub(r'(\w+\.)(rg)',r'\1xy', code)
  code=re.sub(r'(\w+\.)(r)([\s\)\,\;\*\\\-\+])',r'\1x\2', code)
  code=re.sub(r'(\w+\.)(g)([\s\)\,\;\*\\\-\+])',r'\1y\2', code)
  code=re.sub(r'(\w+\.)(b)([\s\)\,\;\*\\\-\+])',r'\1z\2', code)
  code=re.sub(r'(\w+\.)(a)([\s\)\,\;\*\\\-\+])',r'\1w\2', code)

#  code=re.sub(r'(\w+)\.([xyzw]{2,4})',r'swi\2(\1)', code)
  code=re.sub(r'(\w+)\.([xyzw])([xyzw])([\s\)\,\;\*\\\-\+])',r'swi2(\2,\3,\1)\4', code)
  code=re.sub(r'(\w+)\.([xyzw])([xyzw])([xyzw])([\s\)\,\;\*\\\-\+])',r'swi3(\2,\3,\4,\1)\5', code)
  code=re.sub(r'(\w+)\.([xyzw])([xyzw])([xyzw])([xyzw])([\s\)\,\;\*\\\-\+])',r'swi4(\2,\3,\4,\5,\1)\6', code)
  
  
#--- Arrays ---
  code=re.sub(r'(^\s?)(\w+)(\[\s?\])\s*(\w+)',r'\1\2 \4\3', code) #Deklaration
  
#  code=re.sub(r'(^\w+)texture(\s*)\(',r'\g<1>_tex2DVecN\2(',code)
  code=re.sub(r'(.)texture(\s*)\(\s*(\w+)\s*\,\s*(\w+)\s*\)','\g<1>_tex2DVecN\2(\3,\4,\4,15)',code)
#  code=re.sub(r'(sampler2D)(\s*\w+)','__Texture2D__\2',code) #kollidiert noch mit Kernelaufruf - muss dort dann ge√§ndert werden



  for s in [
      # prefix, suffix, fuctions
      [ '' ,   '_f', 'mod'], # '_f' dahinter, um auf eigene Implementierung umzubiegen
      [ '_',   'f' , 'pow|log2|log10|log|copysign|saturate|sqrt|trunc|hypot|cos|sin|cospi|sinpi|tan|acos|asinh|atanh|cosh|sinh|tanh|cbrt|lgamma|tgamma|rsqrt|exp|exp2'],
      [ '_',   '2f', 'atan'],
      [ '_f',  'f' , 'max|min|dim'],
      [ '_' ,  ''  , 'ceil|floor|round|mix'],
      [ '_f',  ''  , 'maf|divide|recip|abs|remainder']
    ]:
    code=re.sub(r'([^\w])('+s[2]+r')(\s*)\(',r'\g<1>'+s[0]+r'\g<2>'+s[1]+r'\3(', code)


  code=re.sub(r'([ \(,\+\-\*=/<>]+)(\.[0-9]+f{0,1})([ \),\+\-\*=;/<>]+)',r'\g<1>0\2\3', code)
  code=re.sub(r'([ \(,\+\-\*=/<>]+)(\.[0-9]+f{0,1})([ \),\+\-\*=;/<>]+)',r'\g<1>0\2\3', code)
  code=re.sub(r'([ \(,\+\-\*=/<>]+)([0-9]+\.)([ \),\+\-\*=;/<>]+)',r'\1\g<2>0\3', code)
  code=re.sub(r'([ \(,\+\-\*=/<>]+)([0-9]+\.)([ \),\+\-\*=;/<>]+)',r'\1\g<2>0\3', code)
  code=re.sub(r'([ \(,\+\-\*=/<>]+)([0-9]+\.[0-9]+)([ \),\+\-\*=;/<>]+)',r'\1\2f\3', code)
  code=re.sub(r'([ \(,\+\-\*=/<>]+)([0-9]+\.[0-9]+)([ \),\+\-\*=;/<>]+)',r'\1\2f\3', code)

  # vecN ... =  -> floatN ... =
  code=re.sub(r'\n(\s*)vec([234])(\s+[_A-Za-z][_A-Za-z0-9]*\s*=)',r'\n\1float\2\3', code)
  code=re.sub(r'\n(\s*)const(\s+)vec([234])(\s+[_A-Za-z][_A-Za-z0-9]*\s*=)',r'\n\1const\2float\3\4', code)

  # ivecN ... =  -> intN ... =
  code=re.sub(r'\n(\s*)ivec([234])(\s+[_A-Za-z][_A-Za-z0-9]*\s*=)',r'\n\1int\2\3', code)
  code=re.sub(r'\n(\s*)const(\s+)ivec([234])(\s+[_A-Za-z][_A-Za-z0-9]*\s*=)',r'\n\1const\2int\3\4', code)



  # vecN(float) -> to_floatN_s(float)
  code=re.sub(r'vec([234])(\s*\(\s*[0-9]+\.[0-9]+f\s*\))',r'to_float\1_s\2', code)

  # versuche floatN_aw zu erwischen - geht aber natuerlich nur sehr bedingt
  code=re.sub(r'vec([34])(\s*\([^,]+,[^,\)]+\))',r'to_float\1_aw\2', code)

  code=re.sub(r'ivec([234])(\s*\()',r'to_int\1\2', code)
  code=re.sub(r'vec([234])(\s*\()',r'to_float\1\2', code)

  # am Schluss alle verbleibenden 'vecN' weghauen:
  code=re.sub(r'([\s\(\)\*\+\-;,=])ivec([234])(\s)',r'\1int\2\3', code)
  code=re.sub(r'([\s\(\)\*\+\-;,=])vec([234])(\s)',r'\1float\2\3', code)

  kernel_name=fuse_name+'Fuse'

  if buffer_name!="Image":
    kernel_name=fuse_name+'Fuse_'+buffer_name

  kernel_name=kernel_name.replace(" ", "")

  kernel_parameters=""

  for e in [
      ['iTime','float iTime'],
      ['iResolution','float2 iResolution'],
      ['iMouse','float4 iMouse'],
      ['iTimeDelta' , 'float iTimeDelta'],
      ['iFrame' , 'int iFrame'],
      ['iChannelTime' , 'float iChannelTime[]'],
      ['iChannelResolution' , 'float3 iChannelResolution[]'],
      ['iDate' , 'float4 iDate'],
      ['iSampleRate' , 'float iSampleRate'],
      ['iChannel0', 'sampler2D iChannel0'],
      ['iChannel1', 'sampler2D iChannel1'],
      ['iChannel2', 'sampler2D iChannel2'],
      ['iChannel3', 'sampler2D iChannel3'],
    ]:
    if code.find(e[0])!=-1: # okay, ein find() ist hier arg grob - aber fuer's erste soll's reichen
      kernel_parameters=kernel_parameters+", "+e[1]


  # Kernelaufruf
  #   Ich erwische dabei nur die mit fragColor und fragCoord? Gibt's bei Shadertoy auch Aufrufe ohne diese beiden,
  #   gar oder mit mehr Parametern?!?
  #
  match_kernel=r'void\s+mainImage\s*\(\s*out\s+float4\s+([A-Za-z_]\w*)\s*,\s*in\s+float2\s+([A-Za-z_]\w*)\s*\)\s*{'

  m = re.search(match_kernel,code)

  if m:
    fragColor=m.group(1)

    code = re.sub(match_kernel,
      '__KERNEL__ void '+kernel_name+'(float4 \\1, float2 \\2'+kernel_parameters+')\n{\n'
      , code)

    # Versuche jetzt am Ende noch etwas reinzuschmieren:

    p=code.rfind("}")

    if p!=-1:
      code=code[0:p] + "\n\n  SetFragmentShaderComputedColor("+ fragColor +");\n" +code[p]
  else:
    print("no kernel")


  # Mal versuchen Funktionen zu finden:

  code=re.sub(r'(\n\s*)(mat[2-4]|float[1-4]{0,1}|int|void|bool)(\s+[A-Za-z_]\w*\s*\([^\)]*\)\s*{)',r'\g<1>__DEVICE__ \g<2>\g<3>',code)


  return code





# ---------------------------------------------------------------------------------------------------------------------

def copyTextFile(src,dst):
  """
  Copy file src to dst.

  There seems to be no such function in `os`or in `io`, but I don't
  want to include another big package just for that simple functionality.
  """
  txt=""
  with open(src, "r") as f:
    txt=f.read()
  with open(dst, "w") as f:
    f.write(txt)





# ---------------------------------------------------------------------------------------------------------------------

def getCacheFilename(path,id):
  """
  See if there is a JSON file with the given `id`.

  This checks `path` and the environments `DOWNLOADS` folder for a file containing the shader `id`.
  """

  files=[entry for entry in os.scandir(path) if entry.is_file() and entry.name.endswith(f".{id}.json")]

  if len(files) > 1:
    raise Exception(f"multiple files matching '{path}*.{id}.json'")

  if len(files) < 1:

    fname=f"shader_{id}.json"

    if os.path.isfile(path + fname):
      return fname

    downloads=os.getenv('DOWNLOADS')

    if downloads!=None and downloads!="":
      if os.path.isfile(downloads + fname):
        print(f"copy '{fname}' from downloads")
        copyTextFile(downloads + fname , path + fname)
      else:
        print(f"found no '{downloads}{fname}' that could be used")
    else:
      print(f"no DOWNLOADS folder configured in environment")

    if os.path.isfile(path + fname):
      return fname

    return None

  return files[0].name





# ---------------------------------------------------------------------------------------------------------------------

def asFuseID(shader_name,shader_id):
  """
  Derive an identifier from shader_name.

  Remove whitespace, leading digits, special characters, etc to make something that can be used as an identifier out of `shader_name`.
  """

  m=re.match(r'^Fork (.+) ([^ ]+) \d+$',shader_name)

  if m != None:
    shader_name=m.group(1)

  return''.join(x for x in re.sub(r'[^A-Za-z0-9 ]+',' ', shader_name).title() if not x.isspace())

# ---------------------------------------------------------------------------------------------------------------------

def asFusename(shader_name,shader_id):
  return asFuseID(shader_name,shader_id)

# ---------------------------------------------------------------------------------------------------------------------

def asKernelname(shader_name,shader_id):
  return asFuseID(shader_name,shader_id)

# ---------------------------------------------------------------------------------------------------------------------

def asConversionBasefilename(shader_name,shader_id):
  return asFuseID(shader_name,shader_id)+"."+shader_id



# ---------------------------------------------------------------------------------------------------------------------

def getJsonData(id,path,nocache=False):
  """
  Get all the Shadertoy information as a JSON structure.
  """

  json_text = None
  cache_filename = None

  # --- try to read from cache

  if not nocache:

    cache_filename = getCacheFilename(path,id)

    if cache_filename:
      print("read from cache ..."+cache_filename)

      with open(path+cache_filename, "r") as f:
        json_text=f.read()


  # --- fetch from shadertoy.com

  if json_text == None:

    print("fetch from shadertoy.com")
    response = requests.get("https://www.shadertoy.com/api/v1/shaders/" +id+"?key="+os.getenv('APIKEY'))

    if response.status_code != 200:
      raise Exception("HTTP Error "+str(response.status_code))

    json_text = response.text


  # --- parse json

  json_data = json.loads(json_text)

  error = json_data.get('Error',None)

  if error != None:
    raise Exception(error)

  if 'Shader' in json_data:
     json_data = json_data['Shader']


  # --- write to cache

  if not nocache:

    fname = asConversionBasefilename(json_data['info']['name'],id) + ".json"

    if cache_filename == None:
      print("write to cache")
      with io.open(path+fname, 'w') as f:
        f.write(json_text)
    else:

      if cache_filename == f"shader_{id}.json":
        print(f"rename '{cache_filename}' to '{fname}'")
        copyTextFile(path+cache_filename,path+fname)
        os.remove(path+cache_filename)
        cache_filename=fname
      else:
        if cache_filename != fname:
          raise Exception(f"cache filename is {cache_filename} but should be '{fname}'")


  # --- fix json data

  if not ('username' in json_data['info']):
    json_data['info']['username']="N.N."

  for entry in json_data['renderpass']:

    for input in entry.get('inputs',{}):

        if not 'ctype' in input:
          input['ctype']=input['type']

        if not 'src' in input:
          input['src']=input['filepath']

        if 'name' in input:
          raise Exception("input already has a name?!?")

        input['name']=input['src']

        if input['ctype']=='buffer':
          m=re.match(r'^/media/previz/buffer0([0-3])\.png$',input['src'])
          if m:
            input['name']="Buffer "+chr( ord('A') + (ord(m.group(1))-ord('0')))
        elif input['ctype']=='keyboard':
          if input['src']=="/presets/tex00.jpg":
            input['name']="Keyboard"



  return json_data





# ---------------------------------------------------------------------------------------------------------------------

def writeYaml(json_data):
  pass





# ---------------------------------------------------------------------------------------------------------------------

def doFetch(id,force=False,nocache=False,noassets=False,nopatch=False):

  path = './Conversions/'

  json_data=getJsonData(id,path,nocache)

  info = json_data['info']


  shader_name = json_data['info']['name']
  fuse_author = os.getenv('AUTHOR')
  fuse_basefname  = path+asConversionBasefilename(shader_name,id)

  if not ('username' in json_data['info']):
    json_data['info']['username']="N.N."

  if os.path.isfile(fuse_basefname+".c") and not force:
    raise Exception("conversion already exists (use -f to overwrite)")

  yaml_data={
        'shader':{
          'id':id,
          'name':shader_name,
          'author': info['username'],
          'url':'https://www.shadertoy.com/view/'+id,
          'description':info['description'],
          'tags':info['tags'],
        },
        'fuse':{
          'id':asFuseID(shader_name,id),
          'name':asFusename(shader_name,id),
          'author':fuse_author

        }
      }

  if "parentid" in info and "parentname" in info:
    yaml_data['shader']['parent']={
      'id':info['parentid'],
      'name':info['parentname'],
      'url':'https://www.shadertoy.com/view/'+info['parentid'],
      }


  with io.open(fuse_basefname+".yaml", 'w', encoding='utf8') as outfile:
      yaml.dump(yaml_data
      ,outfile, default_flow_style=False, allow_unicode=True)





  code=""

  assets_exists=False

  fuse_name=asFusename(shader_name,id)

  for entry in json_data['renderpass']:


    header="\n// ----------------------------------------------------------------------------------\n"+ \
      "// - "+entry['name']+(" "*(79-len(entry['name'])))+"-\n" \
      "// ----------------------------------------------------------------------------------\n"


    # code="\n// ----------------------------------------------------------------------------------\n"+ \
    #   "// - "+entry['name']+(" "*(79-len(entry['name'])))+"-\n" \
    #   "// ----------------------------------------------------------------------------------\n"+ \
    #   "\n\n\n"+patchForDCTL(entry['code'],fuse_name,entry['name'])+"\n\n\n"+code


    inputs=entry.get('inputs',None)

    if inputs!=None and len(inputs)>0:
      buffer_name=re.sub(r'[^A-Za-z0-9_]+','', re.sub(r' ','_', entry['name']))

      if not (noassets or assets_exists or os.path.exists(fuse_basefname+'.assets')):
          os.makedirs(fuse_basefname+'.assets')
          assets_exists = True

      for input in inputs:

          src=input['src']


          ctype=input['ctype']

          input_name = input['name']

          header=header + "// Connect '"+input_name+"' to iChannel"+str(input['channel'])+"\n"

          if src!=None and ctype!=None:
            filename, suffix = os.path.splitext(src)
            filename=f"{fuse_basefname}.assets/{buffer_name}-Channel{input['channel']}-{ctype}{suffix}"

            if not (noassets or os.path.exists(filename)):
              data = requests.get("https://www.shadertoy.com"+src)

              with open(filename, 'wb') as f:
                  f.write(data.content)

    if nopatch:
      code = header + "\n\n" + entry['code'] + code
    else:
      code = header + "\n\n" + patchForDCTL(entry['code'],fuse_name,entry['name']) + code


  with open(fuse_basefname+".c", 'w') as f:
     f.write(code)




# =====================================================================================================================

if not(os.path.isfile(".env")):
  with open(".env", 'w') as f:
     f.write( "AUTHOR=\"\"\n"
              "APIKEY=\"\"\n"
              "DOWNLOADS=\"\"\n"
            )
  print(".env file created - please enter your credentials to use")

load_dotenv()

parser = argparse.ArgumentParser(description='Fetch fuse source code.')
parser.add_argument('-f','--force',action='store_true',help='overwrite code if it already exists')
parser.add_argument('-i','--id', help='shadertoy id as used in the URL', required=True)
parser.add_argument('-nc','--no-cache',action='store_true',help='re-fetch the .json file (assets are not fetched if they exist localy)')
parser.add_argument('-na','--no-assets',action='store_true',help='do not try to download the assets, even if they are not yet existing')
parser.add_argument('-np','--no-patch',action='store_true',help='do not patch the code for DCT√ñL - see normal WebGL in the .c file')
args = parser.parse_args()

try:
  doFetch(args.id,force=args.force,nocache=args.no_cache,noassets=args.no_assets,nopatch=args.no_patch)
except Exception as e:
  print("ERROR: "+str(e))
