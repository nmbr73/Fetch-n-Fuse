
// ----------------------------------------------------------------------------------
// - Buffer A                                                                       -
// ----------------------------------------------------------------------------------
// Connect Buffer A 'Previsualization: Buffer A' to iChannel0

#define texture(ch,uv) _tex2DVecN(ch, (uv).x, (uv).y, 15)



// Random Number Generator
// From https://www.shadertoy.com/view/MsKGWz:
// See Stack Overflow: http://stackoverflow.com/questions/5149544/can-i-generate-a-random-number-inside-a-pixel-shader/10625698#10625698
__DEVICE__ float random_1( float2 p )
{
    float2 r = to_float2(
        23.14069263277926f, // e^pi (Gelfond's constant)
         2.665144142690225f // 2^_sqrtf(2) (Gelfondâ€“Schneider constant)
    );
    return fract( _cosf( mod_f( 12345678.0f, 256.0f * dot(p,r) ) ) );
}

// Samples the neighbourhood (wrapping around where needed)
__DEVICE__ float2 coord (float2 fragCoord, float2 offset, float2 iResolution){
    float x = mod_f(fragCoord.x + offset.x, iResolution.x);
    float y = mod_f(fragCoord.y + offset.y, iResolution.y);
    return to_float2(x, y)/iResolution;
}

__DEVICE__ void sample_tex (float2 fragCoord,float2 iResolution, float4 tex[9], __TEXTURE2D__ iChannel0){
    //float4 tex[9] = vec4[9](
    tex[0] =    (texture(iChannel0, coord(fragCoord, to_float2(-1,  1),iResolution))-0.5f)*10.0f;
    tex[1] =    (texture(iChannel0, coord(fragCoord, to_float2( 0,  1),iResolution))-0.5f)*10.0f;
    tex[2] =    (texture(iChannel0, coord(fragCoord, to_float2( 1,  1),iResolution))-0.5f)*10.0f;
    tex[3] =    (texture(iChannel0, coord(fragCoord, to_float2(-1,  0),iResolution))-0.5f)*10.0f;
    tex[4] =    (texture(iChannel0, coord(fragCoord, to_float2( 0,  0),iResolution))-0.5f)*10.0f;
    tex[5] =    (texture(iChannel0, coord(fragCoord, to_float2( 1,  0),iResolution))-0.5f)*10.0f;
    tex[6] =    (texture(iChannel0, coord(fragCoord, to_float2(-1, -1),iResolution))-0.5f)*10.0f;
    tex[7] =    (texture(iChannel0, coord(fragCoord, to_float2( 0, -1),iResolution))-0.5f)*10.0f;
    tex[8] =    (texture(iChannel0, coord(fragCoord, to_float2( 1, -1),iResolution))-0.5f)*10.0f;
    //);
    return;// tex;
}

// The four kernels used
__DEVICE__ float4 ident(float2 fragCoord, float4 tex[9]){
    return tex[4]; // no offset
}
__DEVICE__ float4 sobel_x(float2 fragCoord, float4 tex[9]){
    float4 result = -1.0f*tex[0]-2.0f*tex[3]-1.0f*tex[6]+1.0f*tex[2]+2.0f*tex[5]+1.0f*tex[8];
    return result;
}
__DEVICE__ float4 sobel_y(float2 fragCoord, float4 tex[9]){
    float4 result = -1.0f*tex[0]-2.0f*tex[1]-1.0f*tex[2]+1.0f*tex[6]+2.0f*tex[7]+1.0f*tex[8];
    return result;
}
__DEVICE__ float4 lap(float2 fragCoord, float4 tex[9]){
    float4 result = 1.0f*tex[0]+2.0f*tex[1]+1.0f*tex[2]+2.0f*tex[3]-12.0f*tex[4]+2.0f*tex[5]+1.0f*tex[6]+2.0f*tex[7]+1.0f*tex[8]; // was an errant +2.
    return result;
}

// Our activation function
__DEVICE__ float relu(float x){
    if (x > 0.0f){return x;}
    return 0.0f;
}


__KERNEL__ void FireClipGuidedJipiFuse__Buffer_A(float4 fragColor, float2 fragCoord, float iTime, float2 iResolution, float4 iMouse, int iFrame, sampler2D iChannel0)
{
    CONNECT_CHECKBOX0(Reset, 0);
  
    const int nh = 16;
    float b1[16] = {-0.08895750343799591f,0.18693439662456512f,-0.10215640813112259f,-0.024140266701579094f,0.18812014162540436f,-0.07431676983833313f,-0.12879067659378052f,0.03979669138789177f,0.2254195362329483f,-0.06369420140981674f,-0.30846360325813293f,0.16137394309043884f,0.1556674689054489f,-0.1745125949382782f,0.1329338252544403f,-0.067245468497276f};
    float w1[256] = {-0.17538994550704956f,0.03855049982666969f,0.08165260404348373f,-0.14766085147857666f,-0.02373511530458927f,-0.2490570843219757f,-0.1484002321958542f,0.06332766264677048f,0.10011060535907745f,-0.12271863222122192f,-0.2196660041809082f,0.21127456426620483f,-0.12545527517795563f,-0.027151215821504593f,-0.16981707513332367f,0.33738356828689575f,0.18344354629516602f,-0.1075463593006134f,0.0943426862359047f,-0.16966302692890167f,-0.10908016562461853f,0.007943480275571346f,-0.3311920464038849f,-0.09868557006120682f,0.12230853736400604f,0.004595356062054634f,0.17450831830501556f,0.005308826919645071f,0.044737558811903f,-0.017442287877202034f,0.15108662843704224f,-0.14895953238010406f,-0.04069491848349571f,0.18987856805324554f,0.3156944215297699f,-0.005401331000030041f,0.18259763717651367f,0.13264232873916626f,0.03851276636123657f,-0.13628703355789185f,0.1341724544763565f,0.25316381454467773f,-0.1470995396375656f,-0.13439320027828217f,0.040220461785793304f,-0.20559747517108917f,0.1800473928451538f,-0.0002454333589412272f,0.07688765972852707f,0.02420109137892723f,-0.04731504246592522f,0.02109590545296669f,0.21335481107234955f,-0.08263152092695236f,0.0447159968316555f,-0.10803763568401337f,-0.49729350209236145f,0.09099029749631882f,-0.19540812075138092f,0.1443025767803192f,-0.021960992366075516f,0.03461490571498871f,0.06777437031269073f,-0.010916417464613914f,0.2381315380334854f,-0.033299099653959274f,-0.06279874593019485f,-0.19658906757831573f,-0.26830488443374634f,-0.14546595513820648f,-0.05664119869470596f,0.15428569912910461f,0.011553062126040459f,0.069498710334301f,0.21324172616004944f,-0.113709457218647f,0.07002183049917221f,0.09510045498609543f,-0.18323026597499847f,-0.15222716331481934f,-0.28965842723846436f,0.21824991703033447f,-0.19380316138267517f,0.062099188566207886f,0.045887596905231476f,0.05893059819936752f,0.033645495772361755f,0.029329391196370125f,0.1350502073764801f,-0.10810217261314392f,0.511446475982666f,0.10979679971933365f,0.17629536986351013f,-0.16141656041145325f,-0.3354191482067108f,0.1085849329829216f,0.31670624017715454f,0.034256596118211746f,-0.2253265529870987f,-0.16446612775325775f,-0.057897813618183136f,0.16564732789993286f,-0.1417941451072693f,-0.012188063003122807f,-0.2710506021976471f,0.029657378792762756f,0.4347728490829468f,0.10073438286781311f,0.16368240118026733f,-0.18598425388336182f,0.04434695094823837f,-0.1657513827085495f,-0.10746873170137405f,0.0125033063814044f,-0.0959276556968689f,-0.0766681581735611f,-0.24970467388629913f,-0.05779816955327988f,0.31133559346199036f,0.18552234768867493f,0.028687776997685432f,0.10550782829523087f,-0.19570505619049072f,-0.1048639565706253f,-0.07463487982749939f,0.1563020944595337f,-0.22440236806869507f,0.011139017529785633f,-0.2538111209869385f,-0.2016170769929886f,0.11734951287508011f,-0.03985316678881645f,0.10761170089244843f,0.12031695246696472f,-0.29957082867622375f,-0.043218739330768585f,0.05417516455054283f,0.07410135120153427f,0.17873908579349518f,-0.07141170650720596f,-0.07378138601779938f,0.24421265721321106f,-0.035165730863809586f,0.24185553193092346f,-0.16343095898628235f,0.22406195104122162f,-0.27038171887397766f,-0.06103401258587837f,-0.08732513338327408f,-0.1371515840291977f,-0.032978255301713943f,-0.06549771130084991f,0.21419751644134521f,-0.03661757707595825f,0.12526869773864746f,-0.024184035137295723f,-0.017598751932382584f,0.25899645686149597f,0.018404759466648102f,0.10164565593004227f,0.16457168757915497f,-0.15311762690544128f,0.039011150598526f,-0.04826344549655914f,0.4582711160182953f,0.030577054247260094f,0.023693779483437538f,-0.0951155424118042f,0.12568223476409912f,-0.11163457483053207f,-0.021251361817121506f,-0.1053682342171669f,-0.36821627616882324f,0.11941825598478317f,-0.08583606779575348f,-0.027468634769320488f,-0.09861423820257187f,0.09845112264156342f,0.08721500635147095f,-0.10322127491235733f,-0.027852635830640793f,0.20933109521865845f,0.11382760852575302f,0.1794089376926422f,-0.11161337792873383f,-0.13195928931236267f,0.0422213077545166f,-0.13869695365428925f,-0.2776845693588257f,0.004577492829412222f,0.08321597427129745f,0.12409359961748123f,-0.282514363527298f,0.003967860247939825f,0.035535912960767746f,0.046880368143320084f,0.19380797445774078f,-0.23538970947265625f,0.05777479708194733f,0.037038352340459824f,-0.10826721042394638f,-0.06837452948093414f,0.11615559458732605f,0.20270438492298126f,-0.009319406002759933f,0.05583568662405014f,-0.11071541160345078f,-0.11987776309251785f,-0.3190040588378906f,0.016342859715223312f,0.02127709425985813f,0.05506376177072525f,-0.13646696507930756f,0.06087152659893036f,0.1721249669790268f,0.1857776641845703f,0.0012511992827057838f,-0.05972207337617874f,-0.029523087665438652f,0.12509272992610931f,0.09803437441587448f,0.2775399088859558f,0.07620524615049362f,0.024330126121640205f,-0.14265844225883484f,0.2508087754249573f,0.13173101842403412f,0.02916962467133999f,0.2508510947227478f,0.20654040575027466f,-0.0837550088763237f,-0.10586166381835938f,0.01163567416369915f,0.14324212074279785f,0.02335534244775772f,0.03753381595015526f,0.17961688339710236f,0.0891367495059967f,-0.0663166344165802f,-0.07575946301221848f,-0.09042377769947052f,-0.004548458382487297f,-0.27805253863334656f,0.015290386974811554f,-0.045146431773900986f,0.022893786430358887f,0.010668765753507614f,0.05474739149212837f,-0.013290387578308582f,0.19267752766609192f,-0.11639795452356339f,0.0012045663315802813f,0.05235595256090164f,-0.2009762078523636f,-0.43161725997924805f,-0.009418309666216373f};
    float w2[64] = {-0.04414569213986397f,0.022859349846839905f,0.08226073533296585f,0.059783902019262314f,-0.011974467895925045f,-0.038100969046354294f,-0.10772471874952316f,0.005907976068556309f,-0.041200488805770874f,0.13681508600711823f,-0.1138051375746727f,0.019381461665034294f,-0.019134297966957092f,0.035059645771980286f,-0.00357038457877934f,0.12725113332271576f,-0.019092170521616936f,-0.021353283897042274f,0.0314985066652298f,0.021054131910204887f,0.06488154828548431f,0.06785503029823303f,0.0043592872098088264f,0.029217198491096497f,-0.05179942771792412f,0.012522397562861443f,-0.031925685703754425f,-0.0006831183563917875f,-0.1021195575594902f,0.13815537095069885f,-0.0624132864177227f,0.12429018318653107f,-0.0081572150811553f,-0.09804004430770874f,-0.07723874598741531f,0.14247852563858032f,0.0025283198338001966f,0.18660148978233337f,0.08029906451702118f,0.02700551599264145f,0.0092658381909132f,-0.10082653909921646f,-0.07435271143913269f,-0.04526136443018913f,-0.03862662985920906f,0.02600231021642685f,-0.030226051807403564f,0.05653006210923195f,0.10955865681171417f,-0.05347215011715889f,-0.1068786159157753f,0.033370472490787506f,-0.05758747085928917f,-0.0023922377731651068f,-0.017472079023718834f,0.024705134332180023f,0.02636687271296978f,-0.020633861422538757f,0.07676155865192413f,0.070289745926857f,-0.05414354428648949f,-0.01701180823147297f,0.0040817176923155785f,-0.049242325127124786f};

  
    fragCoord+=0.5f; 
    // Normalized pixel coordinates (from 0 to 1)
    float2 uv = fragCoord/iResolution;
    
    // Sample BufC for kernels
    float4 tex[9];
    sample_tex(fragCoord,iResolution,tex,iChannel0);
    
    // Apply filters
    float4 id = ident(fragCoord, tex);
    float4 sx = sobel_x(fragCoord, tex);
    float4 sy = sobel_y(fragCoord, tex);
    float4 ll = lap(fragCoord, tex);
    
    // Create x (4 channels x 4 filters, per channel conv)
    float x[16];
    x[0] = id.x;x[1] = sx.x;x[2] = sy.x;x[3] = ll.x;
    x[4] = id.y;x[5] = sx.y;x[6] = sy.y;x[7] = ll.y;
    x[8] = id.z;x[9] = sx.z;x[10] = sy.z;x[11] = ll.z;
    x[12] = id.w;x[13] = sx.w;x[14] = sy.w;x[15] = ll.w;
    
    
    // First layer 
    float l1_out[nh];
    for (int i = 0; i < nh; i++){
        // Dot Product equivalent to:
        // dot_product = x @ w1_i
        float dot_product = 0.0f;
        for (int j = 0; j < 16; j++){
            dot_product += x[j]*w1[i*16+j];
        }
        // Add bias then RELU
        l1_out[i] = relu(dot_product+b1[i]);  ;
    }
    
    // Second layer
    float l2_out[4];
    for (int i = 0; i < 4; i++){
        float dp2 = 0.0f;
        for (int j = 0; j < nh; j++){
            dp2 += l1_out[j]*w2[i*nh+j];
        }
        l2_out[i] = dp2; 
    }
    
    // Proposed update
    float4 y = to_float4(l2_out[0], l2_out[1], l2_out[2], l2_out[3]);
    
    // Output as prev state
    fragColor = id*0.1f + to_float4_s(0.5f);
    
    
    // If (noise>0.5f) apply update
    float2 p = to_float2(uv.x/2.0f+_sinf(iTime/1000.0f), uv.y/2.0f+_cosf(iTime/1000.0f));
    if (random_1(p) < 0.5f){
        fragColor = (id + y)*0.1f + to_float4_s(0.5f);
    }
    
    // If (mouse down) paint grey around it
    if(length(fragCoord-swi2(iMouse,x,y)/2.0f)<(20.0f)){
        if (iMouse.z>0.5f){fragColor = to_float4_s(0.5f);}
    }
    
    // Init 
    if (iFrame==0 || Reset) {fragColor = to_float4_s(0.5f);}

  SetFragmentShaderComputedColor(fragColor);
}
// ----------------------------------------------------------------------------------
// - Image                                                                          -
// ----------------------------------------------------------------------------------
// Connect Image 'Previsualization: Buffer A' to iChannel0


__KERNEL__ void FireClipGuidedJipiFuse(float4 fragColor, float2 fragCoord, float2 iResolution, sampler2D iChannel0)
{

    // Normalized pixel coordinates (from 0 to 1)
    float2 uv = fragCoord/iResolution;
    
    // Apply zoom (can't figure out how to re-size buffers 
    // so this wastes a lot of compute updating the offscreen parts)
    uv = uv/2.0f;

    // Read the buffer
    float3 col = (swi3(_tex2DVecN(iChannel0,uv.x,uv.y,15),x,y,z)-to_float3_s(0.5f))*10.0f + to_float3_s(0.5f);

    // Output to screen
    fragColor = to_float4_aw(col,1.0f);

  SetFragmentShaderComputedColor(fragColor);
}